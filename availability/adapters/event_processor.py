
import datetime
import json
import logging

from dateutil.tz import tzlocal

from kinesis.consumer import KinesisConsumer
from kinesis.state import DynamoDB

from availability.config import AppContext
from availability.domain import Event
from availability.service import AvailabilityEventHandler
from availability.utils import from_isodatetime

log = logging.getLogger(__name__)
# logging.basicConfig()
# logging.getLogger('kinesis.consumer').setLevel(logging.DEBUG)

def process_availability_events(ctx: AppContext):
  log.info('initiating availability event processing')
  handler = AvailabilityEventHandler(ctx.availability_repo)

  consumer = KinesisConsumer(
    stream_name=ctx.availability_cdc_channel,
    state=DynamoDB(table_name=ctx.availability_consumer_table)
  )

  for message in consumer:
    log.info(f"received message {message}")
    event = cdc_message_to_event(message)
    handler.handle(event)


  # produces the following

"""
received message {'SequenceNumber': '49636080407048354368315237172905799799558406021643763714', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 2, 278000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"274830c0-ea7b-433c-9ce3-a5de1ae9363e","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974381510,"Keys":{"version":{"N":"1"},"user_id":{"S":"abc123"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"abc123"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-13T18:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"1"},"user_id":{"S":"abc123"},"correlation_id":{"S":"eb001879-191e-4599-9b23-696a89138f2b"},"created":{"S":"2022-12-13T17:33:01.310159"},"event_id":{"S":"0c692c83-a085-494a-9294-6b2bf9b66df7"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': '03E27A99AD41451219A4D9629E53091C', 'EncryptionType': 'KMS'} of type <class 'dict'>
received message {'SequenceNumber': '49636080407048354368315237172907008725378020650818469890', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 2, 278000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"a8847a20-d63b-4807-b0b8-2b0f79b1cd0d","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974381772,"Keys":{"version":{"N":"3"},"user_id":{"S":"xyz789"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"xyz789"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-13T23:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"3"},"user_id":{"S":"xyz789"},"correlation_id":{"S":"a7fa0aaf-2280-4342-8a49-c7a3af047435"},"created":{"S":"2022-12-13T17:33:01.575213"},"event_id":{"S":"fdc7b489-cd87-4b9f-a8aa-ddad055eb87c"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': 'A742D2F89ADEAA039C676E98AAFC6B2E', 'EncryptionType': 'KMS'} of type <class 'dict'>
received message {'SequenceNumber': '49636080407048354368315237172908217651197635279993176066', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 2, 278000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"4258ebe9-ca16-4fa0-a6a9-441bbb46f131","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974381984,"Keys":{"version":{"N":"5"},"user_id":{"S":"xyz789"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"xyz789"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-14T08:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"5"},"user_id":{"S":"xyz789"},"correlation_id":{"S":"3cd88974-599f-4409-8c68-d9634f6af8ad"},"created":{"S":"2022-12-13T17:33:01.785458"},"event_id":{"S":"d1eecef5-2871-47ef-b436-ffaec918ab8f"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': '0A458277DAAC4084894D3CE30EF53940', 'EncryptionType': 'KMS'} of type <class 'dict'>
received message {'SequenceNumber': '49636080407048354368315237172911844428656479167517294594', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 2, 297000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"a645a9f7-85f9-4fc2-a62f-f8b5d6dabe79","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974382090,"Keys":{"version":{"N":"6"},"user_id":{"S":"xyz789"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"xyz789"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-14T14:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"6"},"user_id":{"S":"xyz789"},"correlation_id":{"S":"fb5eb4e5-80e8-43ca-a06f-a3b142fe477f"},"created":{"S":"2022-12-13T17:33:01.891504"},"event_id":{"S":"6908edf2-3639-40e2-83ef-cc46618a55d1"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': '5A2FF00759AB48CE818C532F187D616B', 'EncryptionType': 'KMS'} of type <class 'dict'>
received message {'SequenceNumber': '49636080407048354368315237172913053354476093796692000770', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 2, 305000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"7473ffbd-a127-464c-b915-1582f3d06aba","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974382241,"Keys":{"version":{"N":"8"},"user_id":{"S":"abc123"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"abc123"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-15T05:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"8"},"user_id":{"S":"abc123"},"correlation_id":{"S":"7db3b832-c41a-4108-988b-850334ee70ba"},"created":{"S":"2022-12-13T17:33:02.043320"},"event_id":{"S":"5bc56d9a-b306-4b0e-9430-ca844b471947"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': '7A0DEB59F21B81B0C7869B8996FF83D7', 'EncryptionType': 'KMS'} of type <class 'dict'>
received message {'SequenceNumber': '49636080407048354368315237172914262280295708425866706946', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 2, 307000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"7fc521e3-40d6-4005-a967-6fe83a0b1669","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974382292,"Keys":{"version":{"N":"9"},"user_id":{"S":"abc123"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"abc123"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-15T14:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"9"},"user_id":{"S":"abc123"},"correlation_id":{"S":"7241ad46-3fb5-4934-8259-d5ecacc8c5bb"},"created":{"S":"2022-12-13T17:33:02.094968"},"event_id":{"S":"e737a651-84d1-45fe-b67a-7197cd56c84e"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': 'B90525E72D82B9743E323930E25D9646', 'EncryptionType': 'KMS'} of type <class 'dict'>
received message {'SequenceNumber': '49636080407070655113513767796037664111274137349752094738', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 2, 275000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"5c48f90b-83eb-4867-afef-2cd1a7c67400","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974381566,"Keys":{"version":{"N":"1"},"user_id":{"S":"xyz789"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"xyz789"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-13T18:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"1"},"user_id":{"S":"xyz789"},"correlation_id":{"S":"0415dad5-3794-4030-ab60-8de82c286eee"},"created":{"S":"2022-12-13T17:33:01.367914"},"event_id":{"S":"4e9cc382-f80b-496b-a5d2-67e09e9c0267"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': '9EB2DC094F31D083DBBAF5587781F5CD', 'EncryptionType': 'KMS'} of type <class 'dict'>
received message {'SequenceNumber': '49636080407070655113513767796038873037093751978926800914', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 2, 278000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"76e98e68-6b8d-48e2-939c-e1606ba14312","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974381616,"Keys":{"version":{"N":"2"},"user_id":{"S":"abc123"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"abc123"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-13T20:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"2"},"user_id":{"S":"abc123"},"correlation_id":{"S":"14069e91-2f90-491a-b799-81912177b8f0"},"created":{"S":"2022-12-13T17:33:01.419288"},"event_id":{"S":"30204b35-fc15-4bc9-9ab1-cb94399a2aad"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': 'AC449E7D97F941AEBB72A24A37567FEC', 'EncryptionType': 'KMS'} of type <class 'dict'>
received message {'SequenceNumber': '49636080407070655113513767796040081962913366608101507090', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 2, 278000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"69d04eb8-7200-4b87-a0b9-bb50f930fd26","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974381669,"Keys":{"version":{"N":"2"},"user_id":{"S":"xyz789"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"xyz789"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-13T20:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"2"},"user_id":{"S":"xyz789"},"correlation_id":{"S":"a2e98942-8ffe-4dea-b678-97902b91f3ab"},"created":{"S":"2022-12-13T17:33:01.471166"},"event_id":{"S":"4fd6db75-681e-44ff-81eb-a6a9864f25e0"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': 'F3BEE92A0FE6A7A56C0ED906E662DF3B', 'EncryptionType': 'KMS'} of type <class 'dict'>
received message {'SequenceNumber': '49636080407070655113513767796041290888732981237276213266', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 2, 278000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"4a64af10-0eff-4526-ac88-c055c59da7ee","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974381719,"Keys":{"version":{"N":"3"},"user_id":{"S":"abc123"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"abc123"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-13T23:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"3"},"user_id":{"S":"abc123"},"correlation_id":{"S":"71deca0d-658e-4d3c-aed3-afc3b04cd9ec"},"created":{"S":"2022-12-13T17:33:01.521947"},"event_id":{"S":"69286f6a-13c0-44e7-8da8-c4eef0122452"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': '0E902CB9F24B17E7CF643886B4DCF3DC', 'EncryptionType': 'KMS'} of type <class 'dict'>
received message {'SequenceNumber': '49636080407070655113513767796042499814552595866450919442', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 2, 278000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"e2662ee1-70fe-47f5-a62a-78a52e2e3a48","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974381825,"Keys":{"version":{"N":"4"},"user_id":{"S":"abc123"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"abc123"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-14T03:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"4"},"user_id":{"S":"abc123"},"correlation_id":{"S":"72f1462b-626f-45f3-ad12-252cf7749ef9"},"created":{"S":"2022-12-13T17:33:01.626106"},"event_id":{"S":"247021ee-1473-4186-b484-d908724373bf"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': 'AABE9D247C2A5C71CDC774254703ADEC', 'EncryptionType': 'KMS'} of type <class 'dict'>
received message {'SequenceNumber': '49636080407070655113513767796043708740372210495625625618', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 2, 278000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"64bc94c0-7bbf-4e0a-8c39-965bab11e194","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974381877,"Keys":{"version":{"N":"4"},"user_id":{"S":"xyz789"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"xyz789"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-14T03:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"4"},"user_id":{"S":"xyz789"},"correlation_id":{"S":"b63df01e-af45-414e-986f-e1fd57c41a43"},"created":{"S":"2022-12-13T17:33:01.679126"},"event_id":{"S":"f4da2c22-d142-45f5-94e4-40e9cd6ee452"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': 'F9102AF5B6FBF93A74CA5C256CFB9501', 'EncryptionType': 'KMS'} of type <class 'dict'>
received message {'SequenceNumber': '49636080407070655113513767796044917666191825124800331794', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 2, 278000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"e9e6c8fb-a2fe-4085-af6e-2035f0b3dbaa","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974381929,"Keys":{"version":{"N":"5"},"user_id":{"S":"abc123"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"abc123"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-14T08:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"5"},"user_id":{"S":"abc123"},"correlation_id":{"S":"d0eaeead-78f1-4ccc-bdd4-6120f2cdef78"},"created":{"S":"2022-12-13T17:33:01.731533"},"event_id":{"S":"1a416adb-1f0e-4151-9720-68a8227f517c"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': '552EB5421F9D90706F69523C92E13046', 'EncryptionType': 'KMS'} of type <class 'dict'>
received message {'SequenceNumber': '49636080407070655113513767796046126592011439753975037970', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 2, 278000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"435cbf72-514a-4176-b48c-6c2f17bb3efa","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974382038,"Keys":{"version":{"N":"6"},"user_id":{"S":"abc123"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"abc123"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-14T14:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"6"},"user_id":{"S":"abc123"},"correlation_id":{"S":"d17a5d24-345f-4fc3-992c-a55d019bff09"},"created":{"S":"2022-12-13T17:33:01.838197"},"event_id":{"S":"752a7681-bff4-4bff-b6fd-4a81d42964e4"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': '73E58A69C4FDDA447D13BF232427F531', 'EncryptionType': 'KMS'} of type <class 'dict'>
received message {'SequenceNumber': '49636080407070655113513767796050962295289898270673862674', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 2, 295000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"7a6d7a30-486d-4acb-a297-960589cb0ccd","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974382139,"Keys":{"version":{"N":"7"},"user_id":{"S":"abc123"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"abc123"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-14T21:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"7"},"user_id":{"S":"abc123"},"correlation_id":{"S":"48e94080-72a7-4534-a661-ec5ec615afb9"},"created":{"S":"2022-12-13T17:33:01.942170"},"event_id":{"S":"587f7cfb-9ede-4ec4-b322-d8ed73f3fbac"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': '88F79FB1F39CDE3BD43461DBCDD09711', 'EncryptionType': 'KMS'} of type <class 'dict'>
received message {'SequenceNumber': '49636080407070655113513767796052171221109512899848568850', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 2, 297000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"90da611c-3f59-4625-b609-8207edaa3510","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974382190,"Keys":{"version":{"N":"7"},"user_id":{"S":"xyz789"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"xyz789"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-14T21:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"7"},"user_id":{"S":"xyz789"},"correlation_id":{"S":"581d4758-a89c-41de-a876-9408fb81e2e8"},"created":{"S":"2022-12-13T17:33:01.992658"},"event_id":{"S":"75daf3bd-5019-4053-8263-1f994e4b9e32"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': '3AAA671C7CB5674C3BD20CFC0077AE55', 'EncryptionType': 'KMS'} of type <class 'dict'>
received message {'SequenceNumber': '49636080407048354368315237172916680131934937821655072770', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 3, 324000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"d0d7ba06-5350-4083-8a45-9e4fbc5ead1f","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974382344,"Keys":{"version":{"N":"10"},"user_id":{"S":"abc123"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"abc123"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-16T00:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"10"},"user_id":{"S":"abc123"},"correlation_id":{"S":"9b40d906-b43f-4e1d-b369-c6055eb25891"},"created":{"S":"2022-12-13T17:33:02.144325"},"event_id":{"S":"ebee2eb1-b24d-44bb-9b7f-3752ac0fe7e7"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': 'EA40DA7B61DE5EB5989BE63E2B932960', 'EncryptionType': 'KMS'} of type <class 'dict'>
received message {'SequenceNumber': '49636080407070655113513767796057006924387971553986347026', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 3, 321000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"8ba83254-78f5-4fc4-bc8a-c0004735a817","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974382400,"Keys":{"version":{"N":"11"},"user_id":{"S":"abc123"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"abc123"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-16T11:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"11"},"user_id":{"S":"abc123"},"correlation_id":{"S":"b99c8a0c-f1c2-43d6-9cbf-dfcdba4e6339"},"created":{"S":"2022-12-13T17:33:02.197874"},"event_id":{"S":"de49f231-b988-4f66-a171-9e9bc01c1ac2"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': '0D4E0C31DA870FC9E8489871D0E8A28F', 'EncryptionType': 'KMS'} of type <class 'dict'>

message = {'SequenceNumber': '49636080407070655113513767796057006924387971553986347026', 'ApproximateArrivalTimestamp': datetime.datetime(2022, 12, 13, 17, 33, 3, 321000, tzinfo=tzlocal()), 'Data': b'{"awsRegion":"us-east-1","eventID":"8ba83254-78f5-4fc4-bc8a-c0004735a817","eventName":"INSERT","userIdentity":null,"recordFormat":"application/json","tableName":"availability-event-store","dynamodb":{"ApproximateCreationDateTime":1670974382400,"Keys":{"version":{"N":"11"},"user_id":{"S":"abc123"}},"NewImage":{"event_payload":{"M":{"user_id":{"S":"abc123"},"appointment_id":{"NULL":true},"available_at":{"S":"2022-12-16T11:00:00"}}},"event_type":{"S":"AvailabilityCreatedEvent"},"version":{"N":"11"},"user_id":{"S":"abc123"},"correlation_id":{"S":"b99c8a0c-f1c2-43d6-9cbf-dfcdba4e6339"},"created":{"S":"2022-12-13T17:33:02.197874"},"event_id":{"S":"de49f231-b988-4f66-a171-9e9bc01c1ac2"}},"SizeBytes":283},"eventSource":"aws:dynamodb"}', 'PartitionKey': '0D4E0C31DA870FC9E8489871D0E8A28F', 'EncryptionType': 'KMS'}

data = json.loads(message['Data'].decode('utf-8'))
"""

def cdc_message_to_event(message) -> Event:
  data = json.loads(message['Data'].decode('utf-8'))\
    .get('dynamodb')\
    .get('NewImage')

  event_data = data['event_payload']['M']

  return Event(
    event_id=data['event_id']['S'],
    user_id=data['user_id']['S'],
    created=from_isodatetime(data['created']['S']),
    event_type=data['event_type']['S'],
    event_payload={
      'user_id': event_data['user_id']['S'],
      'appointment_id': event_data['appointment_id'].get('S'),
      'available_at': from_isodatetime(event_data['available_at']['S'])
    },
    correlation_id=data['correlation_id']['S'],
    version=int(data['version']['N'])
  )
